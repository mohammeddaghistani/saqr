<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>دخول - مبادرة صقر البلد الأمين</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="watermark"></div>
    <div class="login-container">
        <div class="glass-card">
            <img src="logo.png" class="main-logo" alt="Logo">
            <h2>مبادرة صقر البلد الأمين</h2>
            
            <div id="loginStep">
                <input type="text" id="empID" placeholder="أدخل الرقم الوظيفي" inputmode="numeric">
                <button class="btn-gold" id="otpBtn" onclick="requestOTP()">إرسال رمز التحقق</button>
            </div>

            <div id="otpStep" class="hidden">
                <p style="font-size:12px; margin-bottom:10px; color:#fff;">أدخل الرمز المرسل إلى بريدك الإلكتروني</p>
                <input type="text" id="otpInput" placeholder="000000" style="letter-spacing:8px; font-weight:bold; text-align:center;">
                <button class="btn-gold" onclick="verifyOTP()">تأكيد الدخول</button>
                <button class="btn-gold" style="background:none; color:#ddd; border:none; font-size:11px;" onclick="location.reload()">تغيير الرقم الوظيفي</button>
            </div>
        </div>
    </div>

    <script>
        const API = "https://script.google.com/macros/s/AKfycbxrpX6dgTBClMpXdIrklgCGMjCDAC_KqoDbo5li8qsT6c3VH_NeWUKorN9NCzv1ud2S/exec";
        let serverOTP = null;
        let tempUser = null;

        async function requestOTP() {
            const id = document.getElementById('empID').value.trim();
            if(!id) return alert("يرجى إدخال الرقم الوظيفي");
            
            const btn = document.getElementById('otpBtn');
            btn.disabled = true;
            btn.innerText = "جاري الإرسال...";

            try {
                const res = await fetch(`${API}?action=requestOTP&empID=${id}`).then(r => r.json());
                if(res.success) {
                    serverOTP = res.data.otp;
                    tempUser = res.data.user;
                    document.getElementById('loginStep').classList.add('hidden');
                    document.getElementById('otpStep').classList.remove('hidden');
                } else {
                    alert(res.msg);
                    btn.disabled = false;
                    btn.innerText = "إرسال رمز التحقق";
                }
            } catch (e) { 
                alert("فشل الاتصال بالسيرفر"); 
                btn.disabled = false;
            }
        }

        function verifyOTP() {
            const input = document.getElementById('otpInput').value.trim();
            if(input == serverOTP) {
                sessionStorage.setItem('isLoggedIn', 'true');
                sessionStorage.setItem('empID', document.getElementById('empID').value);
                sessionStorage.setItem('userName', tempUser.name);
                sessionStorage.setItem('userRole', tempUser.role);
                window.location.href = 'home.html';
            } else { 
                alert("الرمز الذي أدخلته غير صحيح!"); 
            }
        }
    </script>
</body>
</html>
