<!doctype html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ù…ÙƒØªØ¨ Ø§Ù„Ù…Ø§Ù„ÙŠ (CFO) - Ù…Ø¨Ø§Ø¯Ø±Ø© ØµÙ‚Ø±</title>
    <link rel="icon" type="image/png" href="logo.png">
    <link rel="stylesheet" href="style.css">
    <style>
        .finance-table { width: 100%; border-collapse: collapse; margin-top: 20px; background: rgba(255,255,255,0.02); border-radius: 15px; overflow: hidden; }
        .finance-table th { background: var(--gold); color: #000; padding: 15px; text-align: right; }
        .finance-table td { padding: 12px 15px; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 14px; }
        .amt-pos { color: #4ade80; font-weight: bold; }
        .badge { padding: 4px 10px; border-radius: 6px; font-size: 11px; background: rgba(200,155,60,0.2); color: var(--gold); border: 1px solid var(--gold); }
    </style>
</head>
<body>

<div id="toast"></div>
<div class="watermark"></div>

<header>
    <div style="display: flex; align-items: center; gap: 15px;">
        <img src="logo.png" class="logo-header">
        <h3 style="margin: 0; font-weight: 900;">Ø§Ù„Ø±Ù‚Ø§Ø¨Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ© (CFO)</h3>
    </div>
    <button class="btn-gold" style="width: auto; background: rgba(255,255,255,0.1); color: #fff;" onclick="location.href='home.html'">â¬…ï¸ Ø¹ÙˆØ¯Ø©</button>
</header>

<div class="container" style="padding: 20px; max-width: 1100px; margin: 0 auto;">
    <div class="glass-card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 style="margin: 0; color: var(--gold);">ğŸ’° Ø³Ø¬Ù„ Ø§Ù„ØªØ¯ÙÙ‚Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©</h2>
            <button class="btn-gold" style="width: auto; padding: 5px 15px;" onclick="loadFinanceData()">ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
        </div>

        <div style="overflow-x: auto;">
            <table class="finance-table">
                <thead>
                    <tr>
                        <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                        <th>Ø§Ù„Ù…ÙˆØ¸Ù</th>
                        <th>Ø§Ù„ÙØ¦Ø©</th>
                        <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                        <th>Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
                    </tr>
                </thead>
                <tbody id="finance-body">
                    <tr>
                        <td colspan="5" style="text-align:center; padding:40px; opacity:0.5;">Ø¬Ø§Ø±ÙŠ Ø³Ø­Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø«Ø© Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    const API = "https://script.google.com/macros/s/AKfycbzPMNYU_Q0nTlF8OI6Js4NfXbKjre4I5YspWlg8OdJMa7O1_IZiNjZsvqdfjaPsz46o/exec";

    async function loadFinanceData() {
        try {
            const response = await fetch(API, {
                method: 'POST',
                body: JSON.stringify({ action: 'getStats' }) // Ø³Ù†Ø¹Ø¯Ù„ Ø§Ù„Ø£ÙƒØ´Ù† ÙÙŠ Apps Script Ù„ÙŠØ¬Ù„Ø¨ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø£ÙŠØ¶Ø§Ù‹
            });
            const res = await response.json();
            
            if (res.success) {
                // Ù…Ù„Ø§Ø­Ø¸Ø©: Ø³Ù†Ù‚ÙˆÙ… Ø¨ØªØ­Ø¯ÙŠØ« ÙƒÙˆØ¯ Ø§Ù„Ø³ÙŠØ±ÙØ± Ù„ÙŠØ±Ø³Ù„ Ù…ØµÙÙˆÙØ© Ø§Ù„Ø³Ø¬Ù„Ø§Øª ÙƒØ§Ù…Ù„Ø©
                renderTable(res.data.recentRecords); 
            }
        } catch (error) {
            console.error("Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©");
        }
    }

    function renderTable(records) {
        const body = document.getElementById('finance-body');
        body.innerHTML = '';
        
        if (!records || records.length === 0) {
            body.innerHTML = '<tr><td colspan="5" style="text-align:center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ù…Ø§Ù„ÙŠØ© Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†</td></tr>';
            return;
        }

        records.forEach(rec => {
            const date = new Date(rec.date).toLocaleDateString('ar-SA');
            body.innerHTML += `
                <tr>
                    <td>${date}</td>
                    <td>${rec.empName}</td>
                    <td><span class="badge">${rec.category}</span></td>
                    <td class="amt-pos">${parseFloat(rec.amount).toFixed(2)} Ø±.Ø³</td>
                    <td style="opacity:0.8; font-size:12px;">${rec.notes}</td>
                </tr>
            `;
        });
    }

    // Ø­Ù…Ø§ÙŠØ© Ø§Ù„ØµÙØ­Ø© (Ù„Ù€ CFO ÙˆØ§Ù„Ø£Ø¯Ù…Ù† ÙˆØ§Ù„Ù€ CEO)
    const role = sessionStorage.getItem('userRole');
    if (role !== 'cfo' && role !== 'admin' && role !== 'ceo') {
        window.location.href = "home.html";
    } else {
        loadFinanceData();
    }
</script>

</body>
</html>
